<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.springGroupS.dao.BoardDAO">
	<select id="getBoardList" resultType="com.spring.springGroupS.vo.BoardVO">
		SELECT *, timestampdiff(hour, wDate, now()) AS hourDiff, datediff(now(), wDate) AS dateDiff, 
			(SELECT count(*) FROM boardReply WHERE boardIdx = board.idx) AS replyCnt
			FROM board WHERE complaint != 'DE' 
			<if test="search != ''">AND ${search} LIKE concat("%"#{searchStr}"%")</if> 
			ORDER BY idx DESC LIMIT #{startIndexNo}, #{pageSize};
	</select>
	<select id="getTotRecCnt" resultType="int">
		SELECT count(idx) FROM board WHERE complaint != 'DE' 
			<if test="flag == 'new'">AND wDate >= date_add(now(), interval -7 day)</if>
			<if test="search != ''">AND ${search} LIKE concat("%"#{searchStr}"%")</if>;
	</select>
	<select id="getBoardContent" resultType="com.spring.springGroupS.vo.BoardVO">
		SELECT * FROM board WHERE idx = #{idx};
	</select>
	<select id="getNewBoardList" resultType="com.spring.springGroupS.vo.BoardVO">
		SELECT *, 
			(SELECT count(*) FROM board 
			WHERE wDate >= date_add(now(), interval -7 day)) AS newCount FROM board 
			WHERE wDate >= date_add(now(), interval -7 day) 
			ORDER BY idx DESC 
			<if test="flag == ''">LIMIT 1</if>;
	</select>
	<select id="getPreNextSearch" resultType="com.spring.springGroupS.vo.BoardVO">
		SELECT idx, title FROM board WHERE complaint != 'DE' 
			<if test="str == 'preVO'">AND <![CDATA[idx < #{idx}]]> ORDER BY idx DESC</if>
			<if test="str != 'preVO'">AND <![CDATA[idx > #{idx}]]> ORDER BY idx</if> 
			LIMIT 1;
	</select>
	
	<select id="getBoardReplyList" resultType="com.spring.springGroupS.vo.BoardReplyVO">
		SELECT * FROM boardReply WHERE boardIdx = #{boardIdx} ORDER BY re_order, wDate;
	</select>
	<select id="getBoardParentReplyCheck" resultType="com.spring.springGroupS.vo.BoardReplyVO">
		SELECT * FROM boardReply WHERE boardIdx = #{boardIdx} ORDER BY re_order DESC LIMIT 1;
	</select>
	<select id="getBoardParentReplyIdxCheck" resultType="com.spring.springGroupS.vo.BoardReplyVO">
		SELECT * FROM boardReply WHERE idx = #{idx} ORDER BY re_order DESC LIMIT 1;
	</select>
	
	
	
	<insert id="setBoardInput">
		INSERT INTO board VALUES(DEFAULT, #{vo.mid}, #{vo.nickName}, #{vo.title}, #{vo.content}, #{vo.hostIP}, 
			#{vo.openSW}, DEFAULT, DEFAULT, DEFAULT, DEFAULT);
	</insert>
	
	<insert id="setBoardReplyInput">
		INSERT INTO boardReply VALUES(DEFAULT,#{replyVO.boardIdx},#{replyVO.ref},#{replyVO.re_step},#{replyVO.re_order},#{replyVO.mid},
			#{replyVO.nickName},#{replyVO.content},DEFAULT,#{replyVO.hostIP});
	</insert>
	
	
	
	<update id="setBoardReadNum">
		UPDATE board SET readNum = readNum + 1 WHERE idx = #{idx};
	</update>
	<update id="setBoardGood">
		UPDATE board SET good = good + #{goodCnt} WHERE idx = #{idx};
	</update>
	<update id="setBoardUpdate">
		UPDATE board SET title = #{vo.title}, content = #{vo.content}, hostIP = #{vo.hostIP}, openSW = #{vo.openSW}, wDate = now() WHERE idx = #{vo.idx};
	</update>
	
	<update id="setBoardReplyOrderUp">
		UPDATE boardReply SET re_order = re_order +1 WHERE boardIdx = #{boardIdx} and re_order > #{re_order};
	</update>
	<update id="setBoardReplyOrderBy">
		UPDATE boardReply SET re_order = re_order +${ref} WHERE boardIdx = #{boardIdx} and <![CDATA[re_order > #{re_order}]]> and <![CDATA[ref <= #{ref}]]>;
	</update>
	<update id="setBoardReplyUpdate">
		UPDATE boardReply SET content = #{replyVO.content}, wDate = now(), hostIP = #{replyVO.hostIP} WHERE idx = #{replyVO.idx};
	</update>
	
	
	
	<delete id="setBoardDelete">
		DELETE FROM board WHERE idx = #{idx};
	</delete>
	<delete id="setBoardReplyDelete">
		DELETE FROM boardReply WHERE idx = #{idx};
	</delete>
</mapper>